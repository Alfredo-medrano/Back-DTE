// ========================================
// PRISMA SCHEMA - FAC-ELECTRONICA SAAS
// ========================================
// Base de datos: PostgreSQL (Neon)
// Multi-tenant architecture

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ========================================
// MODELO: TENANT (Cliente SaaS)
// ========================================
model Tenant {
  id        String   @id @default(uuid())
  nombre    String
  email     String   @unique
  telefono  String?
  activo    Boolean  @default(true)
  plan      Plan     @default(BASICO)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relaciones
  emisores Emisor[]
  apiKeys  ApiKey[]
  dtes     Dte[]

  @@map("tenants")
}

// ========================================
// MODELO: EMISOR (Empresa que factura)
// ========================================
// Un Tenant puede tener múltiples emisores (NITs)
model Emisor {
  id              String  @id @default(uuid())
  tenantId        String
  // Datos fiscales
  nit             String  @unique
  nrc             String
  nombre          String
  nombreComercial String?
  codActividad    String
  descActividad   String

  // Dirección
  departamento String @default("06")
  municipio    String @default("14")
  complemento  String
  telefono     String
  correo       String

  // Códigos MH
  codEstableMH        String @default("M001")
  codPuntoVentaMH     String @default("P001")
  tipoEstablecimiento String @default("01")

  // Credenciales MH (ENCRIPTADAS)
  mhClaveApi     String // Encriptado
  mhClavePrivada String // Encriptado

  // Ambiente
  ambiente String  @default("00") // 00=Pruebas, 01=Producción
  activo   Boolean @default(true)

  // Correlativos por tipo DTE
  correlativoFE  Int @default(1)
  correlativoCCF Int @default(1)
  correlativoNC  Int @default(1)
  correlativoND  Int @default(1)
  correlativoFSE Int @default(1)
  correlativoFEX Int @default(1)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relaciones
  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  dtes   Dte[]

  @@map("emisores")
}

// ========================================
// MODELO: API KEY (Autenticación)
// ========================================
model ApiKey {
  id       String @id @default(uuid())
  tenantId String

  key      String @unique // sk_live_xxxx o sk_test_xxxx
  nombre   String // "Producción", "Desarrollo", etc.
  ambiente String @default("00") // 00=Test, 01=Live

  // Permisos
  permisos String[] @default(["dte:create", "dte:read"])

  // Rate limiting
  rateLimit Int @default(100) // Requests per minute

  // Estado
  activo    Boolean   @default(true)
  ultimoUso DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relaciones
  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@map("api_keys")
}

// ========================================
// MODELO: DTE (Documentos Emitidos)
// ========================================
model Dte {
  id       String @id @default(uuid())
  tenantId String
  emisorId String

  // Identificación MH
  codigoGeneracion String @unique
  numeroControl    String @unique
  tipoDte          String // 01, 03, 05, 06, 11, 14
  version          Int    @default(1)
  ambiente         String @default("00")

  // Fechas
  fechaEmision DateTime
  horaEmision  String

  // Receptor
  receptorTipoDoc String
  receptorNumDoc  String
  receptorNombre  String
  receptorCorreo  String?

  // Montos
  totalGravada Decimal @db.Decimal(12, 2)
  totalIva     Decimal @db.Decimal(12, 2)
  totalPagar   Decimal @db.Decimal(12, 2)

  // Estado del proceso
  status DteStatus @default(CREADO)

  // Respuesta MH
  selloRecibido      String?
  fechaProcesamiento DateTime?
  observaciones      String?

  // Documentos
  jsonOriginal Json    // Documento sin firmar
  jsonFirmado  String? // JWS firmado

  // Auditoría
  errorLog String?
  intentos Int     @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relaciones
  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  emisor Emisor @relation(fields: [emisorId], references: [id], onDelete: Cascade)

  // Índices para consultas frecuentes
  @@index([tenantId, fechaEmision])
  @@index([emisorId, tipoDte])
  @@index([status])
  // Índice compuesto para dashboard (ventas del mes por status)
  @@index([emisorId, fechaEmision, status])
  // Índice para retry queue
  @@index([status, intentos])
  @@map("dtes")
}

// ========================================
// ENUMS
// ========================================

enum Plan {
  BASICO // 100 DTEs/mes
  PROFESIONAL // 500 DTEs/mes
  EMPRESARIAL // 2000 DTEs/mes
  ILIMITADO // Sin límite
}

enum DteStatus {
  CREADO // Petición recibida
  VALIDADO // Datos validados
  FIRMADO // Docker firmó OK
  ENVIADO // Enviado a MH
  PROCESADO // MH aceptó, sello recibido
  RECHAZADO // MH rechazó
  ERROR // Error interno
  ANULADO // Invalidado
}
